---
- name: Install MITRE CALDERA
  hosts: Red-Blue
  become: true
  vars:
    caldera_dir: /opt/caldera
    caldera_venv: /opt/caldera/venv

  tasks:
    - name: Install dependencies
      apt:
        name:
          - git
          - python3
          - python3-venv
          - python3-pip
          - build-essential
          - golang
          - npm
        update_cache: yes

    - name: Check if CALDERA repo already exists
      stat:
        path: "{{ caldera_dir }}/.git"
      register: caldera_repo

    - name: Clone CALDERA repository
      git:
        repo: "https://github.com/mitre/caldera.git"
        dest: "{{ caldera_dir }}"
        version: master
        recursive: yes
        force: yes
      when: not caldera_repo.stat.exists

    - name: Ensure CALDERA repository is up to date
      git:
        repo: "https://github.com/mitre/caldera.git"
        dest: "{{ caldera_dir }}"
        version: master
        recursive: yes
        force: yes
      when: caldera_repo.stat.exists

    - name: Create Python virtual environment
      command: python3 -m venv {{ caldera_venv }}
      args:
        creates: "{{ caldera_venv }}"

    - name: Install Python requirements inside venv
      command: "{{ caldera_venv }}/bin/pip install -r requirements.txt"
      args:
        chdir: "{{ caldera_dir }}"

    - name: Create CALDERA systemd service
      copy:
        dest: /etc/systemd/system/caldera.service
        content: |
          [Unit]
          Description=MITRE CALDERA
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory={{ caldera_dir }}
          ExecStart={{ caldera_venv }}/bin/python {{ caldera_dir }}/server.py --insecure --build
          Restart=on-failure

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Enable and start CALDERA service
      systemd:
        name: caldera
        state: started
        enabled: yes

    - name: Wait for CALDERA to be available
      wait_for:
        host: 127.0.0.1
        port: 8888
        delay: 5
        timeout: 800

    - name: Display CALDERA access information
      debug:
        msg: "CALDERA is running. Access it at http://{{ inventory_hostname }}:8888 with default credentials (red/admin)."
