---
- name: Uninstall k3s Kubernetes Cluster
  hosts: PAM-WK-1, PAM-WK-2
  vars:
    k3s_user: "root"

  tasks:
    - name: "[K3S-UNINSTALL] Stop k3s service"
      systemd:
        name: k3s
        state: stopped
        enabled: false
        daemon_reload: true

    - name: "[K3S-UNINSTALL] Run k3s uninstall script if exists"
      shell: |
        if [ -f /usr/local/bin/k3s-uninstall.sh ]; then
          /usr/local/bin/k3s-uninstall.sh
        fi
      ignore_errors: true

    - name: "[K3S-UNINSTALL] Remove k3s binary if exists"
      file:
        path: /usr/local/bin/k3s
        state: absent

    - name: "[K3S-UNINSTALL] Remove k3s service file"
      file:
        path: /etc/systemd/system/k3s.service
        state: absent

    - name: "[K3S-UNINSTALL] Remove kubeconfig for {{ k3s_user }}"
      file:
        path: "{{ (k3s_user == 'root') | ternary('/root/.kube/config', '/home/' + k3s_user + '/.kube/config') }}"
        state: absent

    - name: "[K3S-UNINSTALL] Remove ~/.kube directory if empty"
      file:
        path: "{{ (k3s_user == 'root') | ternary('/root/.kube', '/home/' + k3s_user + '/.kube') }}"
        state: absent
        recurse: true

    - name: "[K3S-UNINSTALL] Reload systemd daemon"
      systemd:
        daemon_reload: true

    - name: "[K3S-UNINSTALL] Verify k3s is gone"
      shell: |
        if command -v k3s >/dev/null 2>&1; then
          echo "k3s still exists"
          exit 1
        else
          echo "âœ… k3s successfully removed"
        fi
      register: uninstall_check
      ignore_errors: true

    - name: "[K3S-UNINSTALL] Display uninstall status"
      debug:
        msg: "{{ uninstall_check.stdout }}"
